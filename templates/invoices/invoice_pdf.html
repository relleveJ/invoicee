<!DOCTYPE html>
{% load tz %}
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4; margin: 2cm; }

        body { font-family: Arial, Helvetica, sans-serif; font-size: 12pt; line-height: 1.6; color: #2d3748; }

        .header { margin-bottom: 24px; border-bottom: 1px solid #e6e6e6; padding-bottom: 12px; }

        .company-info { float: left; width: 55%; }

        .invoice-info { float: right; width: 40%; text-align: right; }

        .clearfix::after { content: ""; display: table; clear: both; }

        .client-info { margin: 20px 0 16px; }

        table { width: 100%; border-collapse: collapse; margin: 12px 0; }

        table th { background-color: #f7fafc; padding: 10px 12px; text-align: left; border-bottom: 1px solid #e2e8f0; color: #2d3748; font-weight: 600; }

        table td { padding: 10px 12px; border-bottom: 1px solid #edf2f7; vertical-align: top; }

        .text-right { text-align: right; }

        .totals { float: right; width: 40%; margin-top: 12px; background: #fff; padding: 8px 12px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }

        .totals table td { border: none; padding: 6px 8px; }

        .total-row { font-weight: bold; font-size: 14pt; background-color: #f7fafc; }

        .footer { margin-top: 40px; padding-top: 18px; border-top: 1px solid #e6e6e6; text-align: center; font-size: 10pt; color: #718096; }

        /* Ad Placement #3: PDF Footer */
        .pdf-ad { background-color: #f8f9fa; padding: 12px; text-align: center; margin-top: 20px; border: 2px dashed #667eea; border-radius: 5px; }
        .pdf-ad h4 { margin: 0 0 8px 0; color: #667eea; }
        .pdf-ad p { margin: 0; font-size: 10pt; }

        /* Preview-only controls (visible when viewing HTML preview in browser iframe) */
        .preview-controls { display:block; text-align:right; margin-bottom:10px; }
        .preview-download-btn { display:inline-block; background:#667eea; color:#fff; padding:8px 12px; border-radius:4px; text-decoration:none; font-size:13px; border:none; }
        .preview-download-btn:hover { background:#5867d6; cursor:pointer; }
    </style>
</head>
<body>
    <!-- HTML preview (no download button) -->

    {% if invoice and business %}
    <div class="header clearfix">
        <div class="company-info">
            {% if business.logo %}
                <img src="{{ business.logo.url }}" style="max-width: 150px; max-height: 80px;" alt="Company Logo">
            {% endif %}
            <h2>{{ business.business_name }}</h2>
            <p>
                {{ business.address }}<br>
                {{ business.city }}, {{ business.state }} {{ business.zip_code }}<br>
                {{ business.country }}<br>
                {{ business.email }}<br>
                {{ business.phone }}
            </p>
        </div>

        <div class="invoice-info">
            <h1>INVOICE</h1>
            <p><small>Created: {% if invoice.created_at %}{{ invoice.created_at|timezone:"Asia/Manila" }}{% else %}{{ now|timezone:"Asia/Manila" }}{% endif %}</small></p>
            <p>
                <strong>Invoice #:</strong> {{ invoice.invoice_number }}<br>
                <strong>Date:</strong> {{ invoice.invoice_date }}<br>
                <strong>Due Date:</strong> {{ invoice.due_date }}<br>
                <strong>Status:</strong> {{ invoice.get_status_display }}
            </p>
        </div>
    </div>
    {% else %}
    <div style="padding:24px; border:1px solid #e6e6e6; border-radius:6px; background:#fff9db;">
        <h3 style="margin-top:0">No preview data</h3>
        <p>Invoice preview cannot be rendered because the server did not provide <strong>invoice</strong> or <strong>business</strong> data.</p>
        <p>If you clicked the preview button from the invoice form, please save the invoice first or check server logs.</p>
    </div>
    {% endif %}
    
    <div class="client-info">
        <h3>Bill To:</h3>
        <p>
            <strong>{% if invoice.client_name %}{{ invoice.client_name }}{% else %}{{ invoice.client.name }}{% endif %}</strong><br>
            {% if invoice.client_email %}{{ invoice.client_email }}{% else %}{{ invoice.client.email }}{% endif %}<br>
            {% if invoice.client_phone %}{{ invoice.client_phone }}{% else %}{{ invoice.client.phone }}{% endif %}<br>
            {% if invoice.client_address %}{{ invoice.client_address }}{% else %}
                {# fall back to client.address or assembled components #}
                {% if invoice.client.address %}
                    {{ invoice.client.address }}
                {% else %}
                    {{ invoice.client.street }}{% if invoice.client.city %}, {{ invoice.client.city }}{% endif %}{% if invoice.client.state %}, {{ invoice.client.state }}{% endif %} {% if invoice.client.zip_code %}{{ invoice.client.zip_code }}{% endif %}{% if invoice.client.country %}, {{ invoice.client.country }}{% endif %}
                {% endif %}
            {% endif %}
        </p>
    </div>
    
    <table>
        <thead>
            <tr>
                <th style="width: 50%;">Description</th>
                <th class="text-right" style="width: 15%;">Quantity</th>
                <th class="text-right" style="width: 17.5%;">Unit Price</th>
                <th class="text-right" style="width: 17.5%;">Total</th>
            </tr>
        </thead>
        <tbody>
            {% if invoice and invoice.items.exists %}
                {% for item in invoice.items.all %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td class="text-right">{{ item.quantity }}</td>
                    <td class="text-right">{{ invoice.currency }} {{ item.unit_price }}</td>
                    <td class="text-right">{{ invoice.currency }} {{ item.line_total }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" style="text-align:center; padding:24px; color:#718096;">No items to display</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
    
    <div class="totals">
        <table>
            <tr>
                <td>Subtotal:</td>
                <td class="text-right">{{ invoice.currency }} {{ invoice.subtotal }}</td>
            </tr>
            <tr>
                <td>Tax ({{ invoice.tax_rate }}%):</td>
                <td class="text-right">{{ invoice.currency }} {{ invoice.tax_amount }}</td>
            </tr>
            <tr>
                <td>Discount:</td>
                <td class="text-right">-{{ invoice.currency }} {{ invoice.discount_amount }}</td>
            </tr>
            <tr class="total-row">
                <td>Total:</td>
                <td class="text-right">{{ invoice.currency }} {{ invoice.total_amount }}</td>
            </tr>
        </table>
    </div>
    
    <div style="clear: both;"></div>
    
    {% if invoice.payment_terms %}
    <div style="margin-top: 30px;">
        <h4>Payment Terms:</h4>
        <p>{{ invoice.payment_terms }}</p>
    </div>
    {% endif %}
    
    {% if invoice.notes %}
    <div>
        <h4>Notes:</h4>
        <p>{{ invoice.notes }}</p>
    </div>
    {% endif %}
    
    <!-- Ad Placement #3: PDF Footer -->
    <div class="pdf-ad">
        <h4>ðŸš€ Powered by Invoice Maker Pro</h4>
        <p>Visit www.example.com/invoice-maker to create professional invoices in minutes!</p>
        <p style="font-size: 9pt; margin-top: 5px;">Get 20% off Premium features with code: PDF2024</p>
    </div>
    
    <div class="footer">
        <p>Thank you for your business!</p>
        <p>This is a computer-generated invoice. For questions, contact {{ business.email }}</p>
    </div>
</body>
</html>